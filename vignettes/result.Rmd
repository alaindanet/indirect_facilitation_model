---
title: "Results of 'Effects of indirect facilitation on ecosystem functioning'"
author: "Alain Danet"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = FALSE}
library(tidyverse)
library(cowplot)
library(magrittr)
devtools::load_all()

dd <- "~/Documents/thesis/talks/coffee_chat/fig"

knitr::opts_chunk$set(
  echo = FALSE,
  fig.dim = c(10, 7) #width, height
  )
cowplot_theme <- theme_get()
theme_set(cowplot_theme)
theme_update(axis.title = element_text(size = 8))
```
```{r export bib citation}
export_citation <- function(pkg_name = NULL, dir_name = NULL){
  x <- toBibtex(citation(pkg_name))
  cat(x, file = paste(dir_name, pkg_name, ".bib", sep = ""), sep = "\n") 
}
sapply(c("simecol", "deSolve"), export_citation, dir_name = "~/Téléchargements/")
```


# Model definition 

```{r, fig.width = 7, fig.height = 5, echo = FALSE}
compute_p_one_z <- function(gamma1, u) {
 1 - exp(- u * gamma1)
}

factors <- list(
  gamma1 = seq(0, .2, .01),
  u = c(0, 5, 10) 
  )

df <- expand.grid(factors) 
df %<>% 
  dplyr::mutate(
  tau = purrr::pmap_dbl(list(gamma1, u), compute_p_one_z),
  u = as.factor(u),
  )

#Plot
p1 <- ggplot(df, aes(x = gamma1, y = tau)) +
  geom_line(aes(colour = u)) +
  labs(
    y = expression(paste("Grazing protection (", p[frac(1,z)], ")")), 
    x = expression(paste("Cost of defense (", gamma, ")"))) +
  ylim(0,1) +
  theme(legend.position="bottom")
p2 <- ggdraw() +
  draw_image(magick::image_read_svg("~/Documents/thesis/papers/indirect_facilitation_dryland_stability/fig/stand_alone.svg"))

fig1 <- plot_grid(p2, p1, labels = "AUTO", rel_heights = c(1, 1), nrow = 2)
fig1
save_plot("~/Documents/thesis/papers/indirect_facilitation_dryland_stability/fig/model.pdf",
  fig1,
  base_width = 3.3,
  base_height = 3.0,
  nrow = 2)
# 39 mm, 84 mm, 129 mm, or 174 mm wide and not higher than 234 mm

```

# Stability 

```{r, echo = FALSE}

load(file = "../inst/scenar_avg_bifurc_u=0_5_gamma1_.1.Rdata")
u0_5 <- scenar_avg

#load(file = "../inst/scenar_birfuc_u_10.RData")
#u10 <- scenar_avg; rm(scenar_avg)
#scenar_avg <- bind_scenar(u0_5, u10)

states <- compute_states(scenar_avg, type = "double")

fig2 <- plot_fig2(states) + theme_alain()
fig2 

#"~/Documents/thesis/papers/indirect_facilitation_dryland_stability/fig/Stability.pdf"
save_plot("~/Documents/thesis/papers/indirect_facilitation_dryland_stability/stability.pdf",
  fig2,
  base_width = 4.3,
  base_height = 3.8,
  ncol = 2)

```

```{r}
g_val <- c(0, .1, .25, .3)
u_val <- c(0, 5)

plot_bifurcation(filter(scenar_avg, g %in% g_val, u %in% u_val)) +
    ggplot2::scale_colour_manual(
      values = c(N = "#BBCC33", P = "#99DDFF")
      ) +
    facet_grid(rows = vars(g), cols = vars(u), labeller =  labeller(u = facet_labeller(prefix = "u"), g = facet_labeller(prefix = "g"))) +
    xylabs(x = "b", y = "rho") +
    theme_alain()
```


# Cooccurrences

## Relating to grazing and aridity

```{r}

filtered_scenar <- filter(scenar_avg, scenario == "together"); 
filtered_scenar$run %<>%
  mutate(
    N = ifelse(N < .05 & N != 0, NA, N),
    P = ifelse(P < .05 & P != 0, NA, P)
    )

occurenres <- compute_occurences(filtered_scenar) 

p <- plot_fig3bisbis(occurenres)
p
ggplot2::ggsave(paste(dd, "clustering_pa_tot.pdf", sep = ""), p, width = 24, height = 18, units = "cm", device = cairo_pdf)
#+
  #geom_contour(aes(z = c), bins = 1, na.rm = TRUE)
  #geom_contour(aes(z = ifelse(is.na(c), 0,1)), bins = 1)

```

## Relating to dispersal and indirect facilitation strength

```{r}
load("../inst/clustering_pa_avg.RData")
clust_avg <- scenar_avg

clust_avg$run %<>%
  mutate(
    g = 0.2, #dummy variable for plot_fig3bisbis
    N = ifelse(N < .0001 & N != 0, 0, N),
    P = ifelse(P < .0001 & P != 0, 0, P)
    )

occurenres <- compute_occurences(clust_avg) 

a <- plot_fig3bisbis(occurenres, x = "del", y = "u", facet = "g")
c1 <- plot_diagram(compute_states(clust_avg), param = c(x = "del", y = "u"))
e <- plot_diagram(occurenres, , param = c(x = "del", y = "u"), fill = "cveg")

```

```{r}
load(file = "../inst/clustering_ca_avg.RData")

##Options 
rho_threshold <- .001

##
scenar_avg$run <- tibble::as.tibble(scenar_avg$run) %>%
  mutate(g = .2)
scenar_avg$run <- arrange(scenar_avg$run, u, del, rep)
occurences <- scenar_avg

# Which simulation is good 
consistence <- occurences$run %>%
  group_by(u, del) %>%
  nest() %>%
  mutate(consistence = map_lgl(data, check_consistency, threshold = rho_threshold))

# Keep the good values
filtered_scenar <- occurences; 
filtered_scenar$run <- unnest(consistence) 
filtered_scenar$run %<>%
  mutate(
    N = ifelse(N < rho_threshold & N != 0, NA, N),
    P = ifelse(P < rho_threshold & P != 0, NA, P),
    qnp = ifelse(is.na(P) | is.na(N), NA, qnp),
    )

#Ok, let's select only the consistent ones.
filtered_scenar$run <- filtered_scenar %>% filter(consistence == TRUE) %>%
  compute_occurences(.) %>%
  .$run %>%
  gather(clustering, value, N:cveg) %>%
  group_by(u, del, clustering) %>%
  summarise(value = mean(value, na.rm = TRUE)) %>%
  spread(clustering, value)
b <- plot_fig3bisbis(filtered_scenar, x = "del", y = "u", facet = "g")
d <- plot_diagram(filtered_scenar, param = c(x = "del", y = "u"), fill = "cveg") +
  xylabs(x = "del", y = "u") +
  scale_fill_temperature()
# Check the white area! Is it zeros ?

```

```{r state_diagram}
filtered_scenar <- occurences
# status var is FALSE (is_run_normal) bc some qnn, qnp, etc... are NaN when P
# and N are absent. We will fix this to not have warning state in the state
#diagram:
filtered_scenar$run <- filter(consistence, consistence == TRUE) %>%
  select(-consistence) %>%
  unnest() %>%
  mutate(
    N = ifelse(N < rho_threshold & N != 0, 0, N),
    P = ifelse(P < rho_threshold & P != 0, 0, P)
    ) %>% filter(rep == 1) %>%
  gather(neighbor, value, qnn:qpp) %>%
  mutate(status = replace(value = NaN, TRUE, FALSE)) %>%
  spread(neighbor, value)

   
states <- compute_states(filtered_scenar, warning_as_desert = FALSE) 

f <- plot_diagram(states, param = c(x = "del", y = "u")) +
  theme_alain()

```

```{r plot states and clustering}
plot_grid(a, b, c1, d, e, f, labels = "AUTO", nrow = 2)

```


## Relating to dispersal and direct facilitation

```{r disp and facilitation, fig.dim = c(10, 4)}

load("../inst/direct_facilitation_effect_pa_avg.RData")
clust_avg <- scenar_avg

clust_avg$run %<>%
  mutate(
    g = 0.2, #dummy variable for plot_fig3bisbis
    N = ifelse(N < .01 & N != 0, 0, N),
    P = ifelse(P < .01 & P != 0, 0, P)
    )

occurences <- compute_occurences(clust_avg) 
filter(occurences$run, is.infinite(100))
summary(occurences$run$cveg)

a <- plot_fig3bisbis(occurences, x = "del", y = "f", facet = "g") +
  xylabs(x = "del", y = "f") + theme_alain()
b <- plot_diagram(compute_states(clust_avg), param = c(x = "del", y = "f")) +
  xylabs(x = "del", y = "f") + theme_alain()
c1 <- plot_diagram(occurences, param = c(x = "del", y = "f"), fill = "cveg") +
  xylabs(x = "del", y = "f") + theme_alain()

cowplot::plot_grid(a, b, c1, labels = "AUTO", ncol = 1)
```

## Relating to aridity and direct facilitation

```{r disp and facilitation, fig.dim = c(10, 4)}

load("../inst/f_b_effect_pa_avg.RData")
clust_avg <- scenar_avg

clust_avg$run %<>%
  mutate(
    g = 0.2, #dummy variable for plot_fig3bisbis
    N = ifelse(N < .01 & N != 0, 0, N),
    P = ifelse(P < .01 & P != 0, 0, P)
    )

occurences <- compute_occurences(clust_avg) 
filter(occurences$run, is.infinite(cveg))
summary(occurences$run$cveg)

a <- plot_fig3bisbis(occurences, x = "b", y = "f", facet = "g") +
  xylabs(x = "b", y = "f") + theme_alain()
b <- plot_diagram(compute_states(clust_avg), param = c(x = "b", y = "f")) +
  xylabs(x = "b", y = "f") + theme_alain()
c1 <- plot_diagram(occurences, param = c(x = "b", y = "f"), fill = "cveg") +
  xylabs(x = "b", y = "f") + theme_alain()

cowplot::plot_grid(a, b, c1, labels = "AUTO", ncol = 1)
```

## Relating to aridity and indirect facilitation

```{r disp and facilitation, fig.dim = c(10, 4)}

load("../inst/u_b_effect_pa_avg.RData")
clust_avg <- scenar_avg

clust_avg$run %<>%
  mutate(
    g = 0.2, #dummy variable for plot_fig3bisbis
    N = ifelse(N < .01 & N != 0, 0, N),
    P = ifelse(P < .01 & P != 0, 0, P)
    )

occurences <- compute_occurences(clust_avg) 
filter(occurences$run, is.infinite(cveg))
summary(occurences$run$cveg)

a <- plot_fig3bisbis(occurences, x = "b", y = "u", facet = "g") +
  xylabs(x = "b", y = "u") + theme_alain() 
b <- plot_diagram(compute_states(clust_avg), param = c(x = "b", y = "u")) +
  xylabs(x = "b", y = "u") + theme_alain()
c1 <- plot_diagram(occurences, param = c(x = "b", y = "u"), fill = "cveg") +
  xylabs(x = "b", y = "u") + theme_alain()

cowplot::plot_grid(a, b, c1, labels = "AUTO", ncol = 1)
```

## Consistence pair approximation and cellular automata

```{r}
# Plot final densities along gradients 

model_type <- c("ca", "pa")
simulation <- list()
for (i in seq_along(model_type)) {
  load(file = paste("../inst/clustering_", model_type[i], "_avg.RData", sep = ""))
  scenar_avg$run %<>% mutate( model = factor(model_type[i], levels = model_type))

  if (model_type[i] == "ca") {
  scenar_avg$run %<>% gather(rho, value, N, P) %>%
  group_by(scenario, u, del, rho, model) %>%
  summarise(value = mean(value, na.rm = TRUE)) %>%
  spread(rho, value)
  }

  simulation[[i]] <- select(scenar_avg$run, scenario, u, del, N, P, model)
  rm(scenar_avg)
}
simulation %<>% bind_rows(simulation)

load(file = paste("../inst/clustering_", model_type[i], "_avg.RData", sep = ""))
scenar_avg$run <- ungroup(simulation) %>%  ##NOT SAFE
  select(-scenario)
scenar_avg$run %<>% gather(rho, value, N, P) %>% 
  group_by(u, del, rho, model) %>%
  mutate(ind = row_number()) %>%
  spread(model, value) %>%
  ungroup() %>% select(-ind) %>%
  mutate(diff_ca_pa = ca - pa)

ca <- plot_diagram(scenar_avg, param = c(x = "del", y = "u"), fill = "diff_ca_pa") + 
  theme_alain() +
  scale_fill_temperature() +
  facet_grid(cols = vars(rho), labeller = species_labeller()) +
  xylabs(x = "del", y = "u")
ca

```
