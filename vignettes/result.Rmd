---
title: "Results of 'Effects of indirect facilitation on ecosystem functioning'"
author: "Alain Danet"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = FALSE}
library(tidyverse)
library(cowplot)
library(magrittr)
devtools::load_all()

knitr::opts_chunk$set(
  echo = FALSE,
  fig.dim = c(10, 7) #width, height
  )

```

# Model definition 

```{r, fig.width = 7, fig.height = 5, echo = FALSE}
compute_p_one_z <- function(gamma1, u) {
 1 - exp(- u * gamma1)
}

factors <- list(
  gamma1 = seq(0, .2, .01),
  u = c(0, 5, 10) 
  )

df <- expand.grid(factors) 
df %<>% 
  dplyr::mutate(
  tau = purrr::pmap_dbl(list(gamma1, u), compute_p_one_z),
  u = as.factor(u),
  )

#Plot
p1 <- ggplot(df, aes(x = gamma1, y = tau)) +
  geom_line(aes(colour = u)) +
  labs(
    y = expression(paste("Protection with one neighbor (", p[frac(1,z)], ")")), 
    x = expression(paste("Cost of defense (", gamma, ")"))) +
  ylim(0,1) +
  theme(legend.position="bottom")
p2 <- ggdraw() +
  draw_image(magick::image_read_svg("~/Documents/thesis/papers/indirect_facilitation_dryland_stability/fig/stand_alone.svg"))

fig1 <- plot_grid(p2, p1, labels = "AUTO", rel_heights = c(1, 1), nrow = 2)
fig1
save_plot("~/Documents/thesis/papers/indirect_facilitation_dryland_stability/fig/model.pdf",
  fig1,
  base_width = 3.3,
  base_height = 2.8,
  nrow = 2)
# 39 mm, 84 mm, 129 mm, or 174 mm wide and not higher than 234 mm

```

# Stability 

```{r, echo = FALSE}

load(file = "./inst/scenar_avg_bifurc_u=0_5_gamma1_.1.Rdata")
u0_5 <- scenar_avg
load(file = "../inst/scenar_birfuc_u_10.RData")
u10 <- scenar_avg; rm(scenar_avg)

scenar_avg <- bind_scenar(u0_5, u10)

states <- compute_states(scenar_avg, type = "double")

fig2 <- plot_fig2(states) + theme_alain()
fig2 

#"~/Documents/thesis/papers/indirect_facilitation_dryland_stability/fig/Stability.pdf"
save_plot("~/Documents/thesis/talks/coffee_chat/fig/stability.pdf",
  fig2,
  base_width = 4.3,
  base_height = 3.8,
  ncol = 2)

```

# Cooccurrences


```{r}


filtered_scenar <- filter(scenar_avg, scenario == "together"); 
filtered_scenar$run %<>%
  mutate(
    N = ifelse(N < .05 & N != 0, NA, N),
    P = ifelse(P < .05 & P != 0, NA, P)
    )

occurenres <- compute_occurences(filtered_scenar) 

occurenres$run %<>%  gather(var, rho, D:cveg) %>%
  mutate(rho = ifelse(rho <= 10^-2 & rho != 0, 0, rho)) %>%
  spread(var, rho)

p <- plot_fig3bisbis(occurenres)
p
ggplot2::ggsave(paste(dd, "clustering_pa_tot.pdf", sep = ""), p, width = 24, height = 18, units = "cm", device = cairo_pdf)
#+
  #geom_contour(aes(z = c), bins = 1, na.rm = TRUE)
  #geom_contour(aes(z = ifelse(is.na(c), 0,1)), bins = 1)

```

